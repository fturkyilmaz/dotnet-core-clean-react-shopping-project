ğŸ“‚ IdentityService.cs Ä°yileÅŸtirmeleri
1. Refresh Token Rotation & Revocation
Eksik: Refresh token rotation var ama revocation list yok.

Fix: KullanÄ±cÄ±ya birden fazla refresh token verilmemeli, aktif refresh token tablosu veya alanÄ± kullanÄ±lmalÄ±.

diff
- user.RefreshToken = newRefreshToken;
- await _userManager.UpdateAsync(user);
+ user.RefreshToken = newRefreshToken;
+ user.RefreshTokenExpiryTime = DateTime.UtcNow.AddDays(_jwtOptions.RefreshTokenExpiryDays);
+ // TODO: Add refresh token revocation list (invalidate old tokens)
+ await _userManager.UpdateAsync(user);
2. Claims GeniÅŸletme
Eksik: Sadece NameIdentifier, Name, Email, Role claimâ€™leri var.

Fix: CorrelationId, TenantId gibi iÅŸlevsel claim eklenebilir.

diff
 var claims = new List<Claim>
 {
     new Claim(ClaimTypes.NameIdentifier, user.Id),
     new Claim(ClaimTypes.Name, user.UserName!),
     new Claim(ClaimTypes.Email, user.Email!),
+    new Claim("CorrelationId", Guid.NewGuid().ToString()),
+    new Claim("TenantId", user.TenantId ?? string.Empty)
 };
3. GetPrincipalFromExpiredToken
Eksik: ValidateLifetime = false doÄŸru ama sadece refresh flow iÃ§in kullanÄ±lmalÄ±.

Fix: Normal API Ã§aÄŸrÄ±larÄ±nda ValidateLifetime = true.


diff
- user.RefreshToken = newRefreshToken;
- await _userManager.UpdateAsync(user);
+ user.RefreshToken = newRefreshToken;
+ user.RefreshTokenExpiryTime = DateTime.UtcNow.AddDays(_jwtOptions.RefreshTokenExpiryDays);
+ await _userManager.UpdateAsync(user);
5. Logging
Eksik: Login ve refresh hatalarÄ± loglanmÄ±yor.

Fix: _logger.LogWarning("Invalid login attempt for {Email}", email); _logger.LogWarning("Invalid refresh token for user {UserId}", userId);

6. Security Improvements
Eksik: Refresh token Base64 string, ama DBâ€™de plaintext tutuluyor.

Fix: Hashâ€™lenmiÅŸ refresh token saklanmalÄ± (Ã¶rn. SHA256).

diff
- user.RefreshToken = refreshToken;
+ user.RefreshToken = HashRefreshToken(refreshToken);
csharp
private string HashRefreshToken(string refreshToken)
{
    using var sha256 = SHA256.Create();
    var bytes = sha256.ComputeHash(Encoding.UTF8.GetBytes(refreshToken));
    return Convert.ToBase64String(bytes);
}
ğŸ¯ Ã–zet
Bu dosyada yapÄ±lacak dÃ¼zeltmeler:

Refresh token rotation + revocation list ekle.

Claims geniÅŸlet (CorrelationId, TenantId).

Refresh sÄ±rasÄ±nda expiry yeniden set et.

Login/refresh hatalarÄ±nÄ± logla.

Refresh token DBâ€™de hashâ€™lenmiÅŸ olarak sakla.

------------------------------

ğŸ“‚ OutboxProcessorService.cs Ä°yileÅŸtirmeleri
1. Retry & Dead-letter Queue
Eksik: BaÅŸarÄ±sÄ±z mesajlar sadece MarkAsFailed ile iÅŸaretleniyor, retry sayÄ±sÄ± veya DLQ yok.

Fix: RetryCount alanÄ± artÄ±rÄ±lmalÄ±, belirli sayÄ±yÄ± aÅŸÄ±nca DLQâ€™ya taÅŸÄ±nmalÄ±.

diff
- message.MarkAsFailed(ex.Message);
+ message.RetryCount++;
+ if (message.RetryCount >= 5)
+ {
+     message.MarkAsDeadLetter(ex.Message);
+     _logger.LogError("Message {Id} moved to DeadLetter after {RetryCount} retries", message.Id, message.RetryCount);
+ }
+ else
+ {
+     message.MarkAsFailed(ex.Message);
+ }
2. Idempotency
Eksik: AynÄ± mesaj birden fazla kez publish edilebilir.

Fix: MessageId veya hash ile idempotency kontrolÃ¼ eklenmeli.

csharp
await messageBus.PublishAsync(@event, cancellationToken, message.Id);
3. Batch Transaction
Eksik: Her mesaj sonrasÄ± SaveChangesAsync Ã§aÄŸrÄ±lÄ±yor.

Fix: TÃ¼m batch iÅŸlendikten sonra tek SaveChangesAsync.

diff
- foreach (var message in unprocessedMessages)
- {
-     ...
-     await context.SaveChangesAsync(cancellationToken);
- }
+ foreach (var message in unprocessedMessages)
+ {
+     ...
+ }
+ await context.SaveChangesAsync(cancellationToken);
4. Structured Logging
Eksik: Loglar sadece string.

Fix: CorrelationId ve event type loglara eklenmeli.

csharp
_logger.LogInformation("Processed outbox message {Id} of type {Type} with CorrelationId {CorrelationId}",
    message.Id, message.Type, message.CorrelationId);
5. Serialization Safety
Eksik: JsonSerializer.Deserialize exception fÄ±rlatabilir.

Fix: JsonSerializerOptions ile gÃ¼venli deserialization.

csharp
var options = new JsonSerializerOptions { PropertyNameCaseInsensitive = true };
var @event = JsonSerializer.Deserialize(message.Content, eventType, options);
6. CancellationToken Respect
Eksik: DÃ¶ngÃ¼ iÃ§inde publish sÄ±rasÄ±nda cancellation token tam kullanÄ±lmÄ±yor.

Fix: PublishAsync ve EF Core sorgularÄ±nda cancellation token zorunlu geÃ§irilmeli (sen zaten geÃ§iriyorsun ama consistency iÃ§in her yerde).

ğŸ¯ Ã–zet
Bu dosyada yapÄ±lacak dÃ¼zeltmeler:

RetryCount + Dead-letter queue ekle.

Idempotency kontrolÃ¼ (MessageId ile).

Batch sonrasÄ± tek SaveChangesAsync.

Structured logging (CorrelationId, EventType).

GÃ¼venli JsonSerializerOptions.

CancellationToken her yerde tutarlÄ± kullan.

+---------------------------
ğŸ“‚ NotificationHub.cs Ä°yileÅŸtirmeleri
1. Claim Extraction TekrarlÄ±lÄ±ÄŸÄ±
Eksik: userId ve roles Ã§Ä±karÄ±mÄ± her metotta tekrar yazÄ±lmÄ±ÅŸ.

Fix: Tek bir yardÄ±mcÄ± private method ile konsolide et.

csharp
private string? GetUserId()
{
    return Context.User?.FindFirst("sub")?.Value
        ?? Context.User?.FindFirst(ClaimTypes.NameIdentifier)?.Value
        ?? Context.User?.Identity?.Name;
}

private List<string> GetUserRoles()
{
    return Context.User?.Claims
        .Where(c => c.Type == ClaimTypes.Role)
        .Select(c => c.Value)
        .ToList() ?? new List<string>();
}
Sonra OnConnectedAsync, OnDisconnectedAsync, SendTestNotification, RegisterPushToken iÃ§inde tekrar eden kod kaldÄ±rÄ±lÄ±r.

2. Group Naming Consistency
Eksik: Role gruplarÄ± role.ToLower() ile ekleniyor, ama prefix yok.

Fix: Daha gÃ¼venli ve tutarlÄ± isimlendirme:

diff
- await Groups.AddToGroupAsync(Context.ConnectionId, role.ToLower());
+ await Groups.AddToGroupAsync(Context.ConnectionId, $"role_{role.ToLower()}");
3. Push Token Storage
Eksik: Token sadece loglanÄ±yor, DB/cacheâ€™e kaydedilmiyor.

Fix: Tokenâ€™Ä± IPushTokenRepository gibi bir servis aracÄ±lÄ±ÄŸÄ±yla kaydet.

csharp
await _pushTokenRepository.SaveAsync(userId, token, platform);
4. Structured Logging
Eksik: Loglarda correlation-id yok.

Fix: Context.ConnectionId veya HttpContext.TraceIdentifier loglara eklenmeli.

csharp
_logger.LogInformation("User {UserId} connected with ConnectionId {ConnectionId}, Roles: {Roles}",
    userId, Context.ConnectionId, string.Join(", ", roles));
5. Error Handling
Eksik: RegisterPushToken ve SendTestNotification hata durumlarÄ±nÄ± ele almÄ±yor.

Fix: Try/catch eklenmeli, ProblemDetails benzeri response dÃ¶ndÃ¼rÃ¼lmeli.

csharp
try
{
    await Clients.Caller.SendAsync("TokenRegistered", new { Success = true });
}
catch (Exception ex)
{
    _logger.LogError(ex, "Error registering push token for {UserId}", userId);
    await Clients.Caller.SendAsync("TokenRegistered", new { Success = false, Message = ex.Message });
}
6. Authorization Granularity
Eksik: [Authorize] attribute global, ama bazÄ± methodlar (Ã¶r. SendTestNotification) sadece admin/test amaÃ§lÄ± olabilir.

Fix: Method bazlÄ± [Authorize(Roles = "Administrator")] eklenmeli.

ğŸ¯ Ã–zet
Bu dosyada yapÄ±lacak dÃ¼zeltmeler:

Claim extraction helper method ile tekrar eden kod temizlenmeli.

Role group isimlendirmesi role_ prefix ile tutarlÄ± hale getirilmeli.

Push token DB/cacheâ€™e kaydedilmeli.

Structured logging (ConnectionId, CorrelationId) eklenmeli.

Error handling try/catch ile gÃ¼Ã§lendirilmeli.

Method bazlÄ± authorization eklenmeli.

--------------

ğŸ“‚ OrderHub.cs Ä°yileÅŸtirmeleri
1. Claim Extraction TekrarlÄ±lÄ±ÄŸÄ±
Eksik: userId Ã§Ä±karÄ±mÄ± her metotta tekrar yazÄ±lmÄ±ÅŸ.

Fix: Tek bir yardÄ±mcÄ± private method ile konsolide et.

csharp
private string? GetUserId()
{
    return Context.User?.FindFirst("sub")?.Value
        ?? Context.User?.FindFirst(ClaimTypes.NameIdentifier)?.Value
        ?? Context.User?.Identity?.Name;
}
Sonra OnConnectedAsync, OnDisconnectedAsync, RequestOrderStatus iÃ§inde tekrar eden kod kaldÄ±rÄ±lÄ±r.

2. Group Naming Consistency
Eksik: Admin grubu "admins" olarak ekleniyor, ama diÄŸer hubâ€™larda role_ prefix kullanÄ±lmasÄ± daha tutarlÄ± olur.

Fix:

diff
- await Groups.AddToGroupAsync(Context.ConnectionId, "admins");
+ await Groups.AddToGroupAsync(Context.ConnectionId, "role_admins");
3. Structured Logging
Eksik: Loglarda sadece userId var.

Fix: ConnectionId ve correlation-id eklenmeli.

csharp
_logger.LogInformation("User {UserId} connected to OrderHub with ConnectionId {ConnectionId}",
    userId, Context.ConnectionId);
4. Error Handling
Eksik: RequestOrderStatus hata durumlarÄ±nÄ± ele almÄ±yor.

Fix: Try/catch eklenmeli.

csharp
try
{
    await Clients.Caller.SendAsync("OrderStatusRequested",
        new { OrderId = orderId, Timestamp = DateTime.UtcNow });
}
catch (Exception ex)
{
    _logger.LogError(ex, "Error sending order status to {UserId}", userId);
    await Clients.Caller.SendAsync("OrderStatusRequested",
        new { Success = false, Message = ex.Message });
}
5. Authorization Granularity
Eksik: [Authorize] global attribute var, ama bazÄ± methodlar (Ã¶rn. RequestOrderStatus) sadece belirli role sahip kullanÄ±cÄ±lar iÃ§in olmalÄ±.

Fix: Method bazlÄ± [Authorize(Roles = "Client,Admin")] eklenmeli.

6. Scalability
Eksik: Hub gruplarÄ± memoryâ€™de tutuluyor, distributed scale-out iÃ§in Redis backplane eklenmeli.

Fix: Startupâ€™da services.AddSignalR().AddStackExchangeRedis("connection-string");.

ğŸ¯ Ã–zet
Bu dosyada yapÄ±lacak dÃ¼zeltmeler:

Claim extraction helper method ile tekrar eden kod temizlenmeli.

Admin group isimlendirmesi role_admins prefix ile tutarlÄ± hale getirilmeli.

Structured logging (ConnectionId, CorrelationId) eklenmeli.

Error handling try/catch ile gÃ¼Ã§lendirilmeli.

Method bazlÄ± authorization eklenmeli.

Redis backplane ile scale-out desteklenmeli.